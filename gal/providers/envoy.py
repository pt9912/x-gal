"""
Envoy Proxy provider implementation.

Generates Envoy Proxy static configuration in YAML format with support
for HTTP/2, gRPC, and Lua-based request transformations.
"""

import os
import requests
from typing import Optional
from ..provider import Provider
from ..config import Config


class EnvoyProvider(Provider):
    """Envoy Proxy gateway provider.

    Generates static configuration for Envoy Proxy, a high-performance
    C++ based edge and service proxy. Supports both REST and gRPC services
    with native HTTP/2 support.

    Output Format:
        YAML file with static_resources configuration including:
        - Listeners with HTTP connection manager
        - Routes with prefix matching
        - Clusters with health checking and load balancing
        - Optional Lua filters for request transformations
        - Admin interface configuration

    Transformations:
        Implemented using Envoy's Lua filter (envoy.filters.http.lua).
        Provides inline Lua code for:
        - Setting default field values
        - Generating computed fields (UUID, timestamp)
        - Request body manipulation

    gRPC Support:
        Automatic HTTP/2 protocol configuration for gRPC services.
        Uses http2_protocol_options on clusters.

    Example:
        >>> provider = EnvoyProvider()
        >>> provider.name()
        'envoy'
        >>> config = Config.from_yaml("gateway.yaml")
        >>> output = provider.generate(config)
        >>> "static_resources:" in output
        True

    See Also:
        https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/overview
    """

    def name(self) -> str:
        """Return provider name.

        Returns:
            str: "envoy"
        """
        return "envoy"

    def validate(self, config: Config) -> bool:
        """Validate configuration for Envoy.

        Ensures that required configuration parameters are present
        and valid for Envoy deployment.

        Args:
            config: Configuration to validate

        Returns:
            True if validation passes

        Raises:
            ValueError: If port is 0 or invalid

        Example:
            >>> provider = EnvoyProvider()
            >>> config = Config(version="1.0", provider="envoy",
            ...                 global_config=GlobalConfig(port=8080),
            ...                 services=[])
            >>> provider.validate(config)
            True
        """
        if config.global_config.port == 0:
            raise ValueError("Port must be specified")
        return True

    def generate(self, config: Config) -> str:
        """Generate Envoy static configuration in YAML format.

        Creates a complete Envoy static_resources configuration including
        listeners, routes, clusters, and optional Lua transformation filters.

        Configuration Structure:
            - static_resources:
                - listeners: HTTP connection manager with routes
                - clusters: Upstream service definitions
            - admin: Admin interface configuration

        Args:
            config: Configuration object containing services and settings

        Returns:
            Complete Envoy YAML configuration as string

        Example:
            >>> provider = EnvoyProvider()
            >>> config = Config.from_yaml("config.yaml")
            >>> yaml_output = provider.generate(config)
            >>> "listeners:" in yaml_output
            True
            >>> "clusters:" in yaml_output
            True
        """
        output = []
        output.append("# Envoy Configuration Generated by GAL")
        output.append(f"# Provider: {config.provider}")
        output.append(f"# Services: {len(config.services)} ({len(config.get_grpc_services())} gRPC, {len(config.get_rest_services())} REST)")
        output.append("")
        
        # Static resources
        output.append("static_resources:")
        output.append("  listeners:")
        output.append("  - name: listener_0")
        output.append("    address:")
        output.append("      socket_address:")
        output.append(f"        address: {config.global_config.host}")
        output.append(f"        port_value: {config.global_config.port}")
        output.append("    filter_chains:")
        output.append("    - filters:")
        output.append("      - name: envoy.filters.network.http_connection_manager")
        output.append("        typed_config:")
        output.append("          '@type': type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager")
        output.append("          stat_prefix: ingress_http")
        output.append("          codec_type: AUTO")
        output.append("          route_config:")
        output.append("            name: local_route")
        output.append("            virtual_hosts:")
        output.append("            - name: backend")
        output.append("              domains: ['*']")
        output.append("              routes:")
        
        # Routes
        for service in config.services:
            for route in service.routes:
                output.append(f"              - match:")
                output.append(f"                  prefix: '{route.path_prefix}'")
                if service.type == "grpc":
                    output.append("                  grpc: {}")
                output.append("                route:")
                output.append(f"                  cluster: {service.name}_cluster")
        
        # HTTP filters
        output.append("          http_filters:")
        
        # Add transformation filter if any service has transformations
        has_transformations = any(s.transformation and s.transformation.enabled for s in config.services)
        if has_transformations:
            output.append("          - name: envoy.filters.http.lua")
            output.append("            typed_config:")
            output.append("              '@type': type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua")
            output.append("              inline_code: |")
            output.append("                function envoy_on_request(request_handle)")
            output.append("                  -- Transformation logic here")
            output.append("                  local path = request_handle:headers():get(':path')")
            
            for service in config.services:
                if service.transformation and service.transformation.enabled:
                    output.append(f"                  -- {service.name} transformations")
                    for route in service.routes:
                        output.append(f"                  if string.find(path, '{route.path_prefix}') then")
                        output.append("                    local body = request_handle:body()")
                        output.append("                    if body then")
                        output.append("                      -- Apply defaults and computed fields")
                        output.append("                    end")
                        output.append("                  end")
            
            output.append("                end")
        
        output.append("          - name: envoy.filters.http.router")
        output.append("            typed_config:")
        output.append("              '@type': type.googleapis.com/envoy.extensions.filters.http.router.v3.Router")
        output.append("")
        
        # Clusters
        output.append("  clusters:")
        for service in config.services:
            output.append(f"  - name: {service.name}_cluster")
            output.append("    type: STRICT_DNS")
            output.append("    lb_policy: ROUND_ROBIN")
            if service.type == "grpc":
                output.append("    http2_protocol_options: {}")
            output.append("    load_assignment:")
            output.append(f"      cluster_name: {service.name}_cluster")
            output.append("      endpoints:")
            output.append("      - lb_endpoints:")
            output.append("        - endpoint:")
            output.append("            address:")
            output.append("              socket_address:")
            output.append(f"                address: {service.upstream.host}")
            output.append(f"                port_value: {service.upstream.port}")
            output.append("")
        
        # Admin
        output.append("admin:")
        output.append("  address:")
        output.append("    socket_address:")
        output.append(f"      address: {config.global_config.host}")
        output.append(f"      port_value: {config.global_config.admin_port}")

        return "\n".join(output)

    def deploy(self, config: Config, output_file: Optional[str] = None,
               admin_url: Optional[str] = None) -> bool:
        """Deploy Envoy configuration.

        Deploys configuration via file-based approach. Optionally triggers
        hot-reload via Envoy Admin API if admin_url is provided.

        Deployment Methods:
            1. File-based (default): Write config to file for Envoy to load
            2. Hot-reload (optional): Trigger config reload via Admin API

        Args:
            config: Configuration to deploy
            output_file: Path to write config file (default: envoy.yaml)
            admin_url: Envoy Admin API URL (default: http://localhost:9901)

        Returns:
            True if deployment successful

        Raises:
            IOError: If file write fails
            requests.RequestException: If Admin API call fails

        Example:
            >>> provider = EnvoyProvider()
            >>> config = Config.from_yaml("config.yaml")
            >>> # File-based deployment
            >>> provider.deploy(config, output_file="/etc/envoy/envoy.yaml")
            True
            >>> # With hot-reload
            >>> provider.deploy(config, admin_url="http://envoy:9901")
            True
        """
        # Generate configuration
        generated_config = self.generate(config)

        # Determine output file
        if output_file is None:
            output_file = "envoy.yaml"

        # Write configuration to file
        try:
            # Create directory if it doesn't exist
            os.makedirs(os.path.dirname(output_file) or ".", exist_ok=True)

            with open(output_file, 'w') as f:
                f.write(generated_config)

            print(f"✓ Envoy configuration written to {output_file}")
        except IOError as e:
            print(f"✗ Failed to write config file: {e}")
            return False

        # Optionally trigger hot-reload via Admin API
        if admin_url:
            admin_url = admin_url.rstrip('/')
            try:
                # Check if Envoy is reachable
                response = requests.get(f"{admin_url}/ready", timeout=5)

                if response.status_code == 200:
                    print(f"✓ Envoy Admin API is reachable at {admin_url}")
                    print("  Note: File-based config requires Envoy restart or --drain-strategy")
                    print(f"  To reload: docker restart <envoy-container>")
                else:
                    print(f"⚠ Envoy Admin API returned status {response.status_code}")

            except requests.RequestException as e:
                print(f"⚠ Could not reach Envoy Admin API: {e}")
                print(f"  Config written to {output_file}, but manual reload required")

        return True
