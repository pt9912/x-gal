# GAL v1.1.0 - Implementierungsplan

**Target Release:** Q4 2025
**Focus:** Traffic Management & Security Basics
**Estimated Effort:** 6-8 Wochen

---

## 📋 Feature Overview

| # | Feature | Priority | Status | Effort | Dependencies |
|---|---------|----------|--------|--------|--------------|
| 1 | Rate Limiting | 🔴 High | ✅ **Done** | 2 Wochen | - |
| 2 | Authentication (Basic/API Key/JWT) | 🔴 High | ✅ **Done** | 2 Wochen | - |
| 3 | Request/Response Headers | 🔴 High | 🔄 Pending | 1 Woche | - |
| 4 | CORS Policies | 🔴 High | 🔄 Pending | 1 Woche | - |
| 5 | PyPI Publication | 🔴 High | 🔄 Pending | 1 Woche | - |
| 6 | Circuit Breaker | 🟡 Medium | 🔄 Pending | 1.5 Wochen | Optional |
| 7 | Health Checks & Load Balancing | 🟡 Medium | 🔄 Pending | 2 Wochen | Optional |

**Total Estimated Effort:** 10.5 Wochen (mit optionalen Features)
**Progress:** 2/7 Features completed (38% - 4 von 10.5 Wochen)

---

## 🎯 Feature 1: Rate Limiting ✅

**Status:** ✅ **IMPLEMENTIERT** (Commit: `6a67803`)
**Branch:** `feature/v1.1.0-rate-limiting`
**Completed:** 2025-10-17

### Implementation Summary

✅ **Config Model** - RateLimitConfig mit allen Optionen
✅ **Kong Provider** - rate-limiting Plugin
✅ **APISIX Provider** - limit-count Plugin
✅ **Traefik Provider** - rateLimit Middleware
✅ **Envoy Provider** - local_ratelimit Filter
✅ **Tests** - 15 neue Tests, 117 total (alle bestehen)
✅ **Documentation** - Umfassender RATE_LIMITING.md Guide
✅ **Coverage** - 90% (erhöht von 89%)

### Motivation
- Schutz vor API-Überlastung
- DDoS-Mitigation
- Fairness zwischen Clients
- SLA-Enforcement

### Configuration Schema

```yaml
routes:
  - path: /api/users
    method: GET
    upstream: user_service
    rate_limit:
      enabled: true
      requests_per_second: 100
      burst: 200
      key_type: ip_address  # ip_address, header, jwt_claim
      key_header: X-API-Key  # Optional: wenn key_type=header
      response:
        status_code: 429
        message: "Rate limit exceeded"
```

### Implementation Tasks

#### Config Model (`gal/config.py`)
```python
class RateLimitConfig:
    enabled: bool = True
    requests_per_second: int
    burst: int = 0
    key_type: str = "ip_address"  # ip_address, header, jwt_claim
    key_header: Optional[str] = None
    key_claim: Optional[str] = None
    response_status: int = 429
    response_message: str = "Rate limit exceeded"
```

#### Provider Implementations

**Envoy (`gal/providers/envoy.py`)**
```python
def _generate_rate_limit(self, route_config):
    """
    Uses Envoy's rate limit filter
    Requires external rate limit service (Redis-based)
    """
    return {
        "typed_config": {
            "@type": "type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit",
            "domain": "api_gateway",
            "rate_limit_service": {
                "grpc_service": {
                    "envoy_grpc": {
                        "cluster_name": "rate_limit_cluster"
                    }
                }
            }
        }
    }
```

**Kong (`gal/providers/kong.py`)**
```python
def _generate_rate_limit(self, route_config):
    """
    Uses Kong's rate-limiting plugin
    """
    return {
        "name": "rate-limiting",
        "config": {
            "second": route_config.rate_limit.requests_per_second,
            "policy": "local",  # or 'cluster', 'redis'
            "fault_tolerant": True,
            "hide_client_headers": False
        }
    }
```

**APISIX (`gal/providers/apisix.py`)**
```python
def _generate_rate_limit(self, route_config):
    """
    Uses APISIX's limit-count plugin
    """
    return {
        "limit-count": {
            "count": route_config.rate_limit.requests_per_second,
            "time_window": 1,
            "rejected_code": 429,
            "key": "remote_addr"  # or 'consumer_name', 'server_addr'
        }
    }
```

**Traefik (`gal/providers/traefik.py`)**
```python
def _generate_rate_limit(self, route_config):
    """
    Uses Traefik's RateLimit middleware
    """
    return {
        "rateLimit": {
            "average": route_config.rate_limit.requests_per_second,
            "burst": route_config.rate_limit.burst,
            "sourceCriterion": {
                "requestHost": True  # or ipStrategy
            }
        }
    }
```

#### Testing
- Unit Tests für Config-Parsing
- Provider-spezifische Tests
- Integration Tests mit Mock-Gateways
- Load Tests (optional)

#### Documentation
- Configuration Guide
- Provider-specific Notes
- Best Practices
- Migration Guide from custom configs

---

## 🔐 Feature 2: Authentication & Authorization ✅

**Status:** ✅ **IMPLEMENTIERT**
**Branch:** `feature/v1.1.0-authentication`
**Completed:** 2025-10-17

### Implementation Summary

✅ **Config Models** - BasicAuthConfig, ApiKeyConfig, JwtConfig, AuthenticationConfig
✅ **Kong Provider** - basic-auth, key-auth, jwt plugins
✅ **APISIX Provider** - basic-auth, key-auth, jwt-auth plugins
✅ **Traefik Provider** - basicAuth, forwardAuth middleware
✅ **Envoy Provider** - jwt_authn filter, Lua filter für Basic Auth/API Key
✅ **Tests** - 33 neue Tests (21 authentication + 12 config), 145 total (alle bestehen)
✅ **Documentation** - Umfassender AUTHENTICATION.md Guide (600+ Zeilen)
✅ **Example Config** - examples/authentication-test.yaml mit 9 Szenarien
✅ **Coverage** - 91% (erhöht von 90%)

### Motivation
- API-Zugriffskontrolle
- User Identity Management
- Token-basierte Auth
- Standards-Konformität (JWT, OAuth2)

### Configuration Schema

```yaml
routes:
  - path: /api/protected
    method: GET
    upstream: protected_service
    authentication:
      type: jwt  # basic, api_key, jwt, oauth2

      # Basic Auth Config
      basic:
        users:
          - username: admin
            password_hash: "$2b$12$..."

      # API Key Config
      api_key:
        header_name: X-API-Key
        query_param: api_key
        keys:
          - key: "abc123..."
            name: "client_1"

      # JWT Config
      jwt:
        issuer: https://auth.example.com
        audiences: ["api"]
        jwks_uri: https://auth.example.com/.well-known/jwks.json
        header_name: Authorization
        header_prefix: "Bearer "
        claims_to_headers:
          - claim: sub
            header: X-User-ID
          - claim: email
            header: X-User-Email
```

### Implementation Tasks

#### Config Model
```python
class AuthenticationConfig:
    type: str  # basic, api_key, jwt, oauth2
    basic: Optional[BasicAuthConfig] = None
    api_key: Optional[ApiKeyConfig] = None
    jwt: Optional[JwtConfig] = None
    oauth2: Optional[OAuth2Config] = None

class JwtConfig:
    issuer: str
    audiences: List[str]
    jwks_uri: str
    algorithms: List[str] = ["RS256"]
    header_name: str = "Authorization"
    header_prefix: str = "Bearer "
    claims_to_headers: List[ClaimMapping] = []
```

#### Provider Implementations

**Envoy - JWT Auth**
```python
def _generate_jwt_auth(self, auth_config):
    return {
        "name": "envoy.filters.http.jwt_authn",
        "typed_config": {
            "@type": "type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication",
            "providers": {
                "auth_provider": {
                    "issuer": auth_config.jwt.issuer,
                    "audiences": auth_config.jwt.audiences,
                    "remote_jwks": {
                        "http_uri": {
                            "uri": auth_config.jwt.jwks_uri,
                            "cluster": "jwks_cluster"
                        }
                    }
                }
            }
        }
    }
```

**Kong - Multiple Auth Plugins**
```python
def _generate_authentication(self, auth_config):
    if auth_config.type == "jwt":
        return {
            "name": "jwt",
            "config": {
                "uri_param_names": ["jwt"],
                "claims_to_verify": ["exp"],
                "key_claim_name": "iss"
            }
        }
    elif auth_config.type == "api_key":
        return {
            "name": "key-auth",
            "config": {
                "key_names": [auth_config.api_key.header_name],
                "hide_credentials": True
            }
        }
```

#### Testing
- JWT Token Generation für Tests
- Mock JWKS Endpoint
- Auth Success/Failure Scenarios
- Token Expiration Tests
- Multiple Auth Methods Tests

---

## 🔄 Feature 3: Request/Response Headers

### Configuration Schema

```yaml
routes:
  - path: /api/service
    transformations:
      request:
        add_headers:
          X-Request-ID: "{{ uuid() }}"
          X-Timestamp: "{{ now() }}"
          X-Forwarded-By: "GAL"
        remove_headers:
          - X-Internal-Token
          - X-Debug-Info
        set_headers:
          X-Custom: "fixed-value"

      response:
        add_headers:
          X-Response-Time: "{{ response_time_ms }}"
          X-Cache-Status: "{{ cache_status }}"
        remove_headers:
          - Server
          - X-Powered-By
```

### Implementation

Erweitere bestehende Transformations-Engine:
```python
class HeaderTransformation:
    add_headers: Dict[str, str] = {}
    remove_headers: List[str] = []
    set_headers: Dict[str, str] = {}

class TransformationConfig:
    request: Optional[HeaderTransformation] = None
    response: Optional[HeaderTransformation] = None
```

#### Template Support
```python
def _evaluate_template(self, template: str, context: Dict) -> str:
    """
    Supports:
    - {{ uuid() }} - Generate UUID
    - {{ now() }} - Current timestamp
    - {{ request.header.X-Name }} - Request header value
    - {{ env.VAR_NAME }} - Environment variable
    """
    # Use Jinja2 or simple regex replacement
```

---

## 🌐 Feature 4: CORS Policies

### Configuration Schema

```yaml
routes:
  - path: /api/public
    cors:
      enabled: true
      allowed_origins:
        - https://app.example.com
        - https://admin.example.com
      allowed_origins_regex:
        - "^https://.*\\.example\\.com$"
      allowed_methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowed_headers:
        - Content-Type
        - Authorization
        - X-Custom-Header
      expose_headers:
        - X-Request-ID
      allow_credentials: true
      max_age: 3600
```

### Provider Implementations

**Envoy - CORS Filter**
```python
def _generate_cors(self, cors_config):
    return {
        "name": "envoy.filters.http.cors",
        "typed_config": {
            "@type": "type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors"
        }
    }
```

**Kong - CORS Plugin**
```python
def _generate_cors(self, cors_config):
    return {
        "name": "cors",
        "config": {
            "origins": cors_config.allowed_origins,
            "methods": cors_config.allowed_methods,
            "headers": cors_config.allowed_headers,
            "credentials": cors_config.allow_credentials,
            "max_age": cors_config.max_age
        }
    }
```

---

## 📦 Feature 5: PyPI Publication

### Tasks

1. **Package Preparation**
   - ✅ pyproject.toml already exists
   - ✅ setup.py already exists
   - ✅ MANIFEST.in configured
   - 🔲 Add classifiers for v1.1.0 features

2. **PyPI Account Setup**
   - Create PyPI account
   - Configure 2FA
   - Generate API Token
   - Add to GitHub Secrets

3. **Release Workflow Update**
   ```yaml
   publish-pypi:
     if: true  # Enable!
     steps:
       - name: Publish to PyPI
         env:
           TWINE_USERNAME: __token__
           TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
         run: twine upload dist/*
   ```

4. **Testing**
   - Test on TestPyPI first
   - Verify installation: `pip install gal-gateway`
   - Test CLI: `gal --version`

5. **Documentation**
   - Update README with PyPI installation
   - Add PyPI badge
   - Installation troubleshooting guide

---

## 📊 Testing Strategy

### Test Coverage Goals
- **Unit Tests:** 95%+ coverage
- **Integration Tests:** All provider combinations
- **E2E Tests:** Real gateway deployments (optional)

### Test Structure
```
tests/
├── unit/
│   ├── test_rate_limiting.py
│   ├── test_authentication.py
│   ├── test_headers.py
│   └── test_cors.py
├── integration/
│   ├── test_envoy_rate_limit.py
│   ├── test_kong_jwt_auth.py
│   └── test_apisix_cors.py
└── e2e/
    └── test_complete_workflow.py
```

### Test Fixtures
```python
@pytest.fixture
def rate_limit_config():
    return RateLimitConfig(
        requests_per_second=100,
        burst=200,
        key_type="ip_address"
    )

@pytest.fixture
def jwt_auth_config():
    return JwtConfig(
        issuer="https://auth.test",
        audiences=["api"],
        jwks_uri="https://auth.test/.well-known/jwks.json"
    )
```

---

## 📚 Documentation Plan

### New Documentation Files

1. **`docs/guides/RATE_LIMITING.md`**
   - Configuration examples
   - Provider-specific notes
   - Best practices
   - Troubleshooting

2. **`docs/guides/AUTHENTICATION.md`**
   - All auth types explained
   - JWT setup guide
   - API key management
   - Security considerations

3. **`docs/guides/HEADERS.md`**
   - Header manipulation patterns
   - Template syntax
   - Use cases

4. **`docs/guides/CORS.md`**
   - CORS explained
   - Configuration examples
   - Browser compatibility

5. **`docs/guides/MIGRATION.md`**
   - v1.0 → v1.1 migration guide
   - Breaking changes
   - New features adoption

### README Updates
- Add v1.1.0 features to feature list
- Update Quick Start with new examples
- Add PyPI installation section

---

## 🚀 Release Plan

### Pre-Release Checklist

- [ ] All features implemented
- [ ] Tests passing (95%+ coverage)
- [ ] Documentation complete
- [ ] CHANGELOG.md updated
- [ ] RELEASE_NOTES updated
- [ ] Migration guide written
- [ ] PyPI package tested on TestPyPI
- [ ] Docker images built and tested
- [ ] GitHub release notes prepared

### Release Steps

1. **Create Release Branch**
   ```bash
   git checkout -b release/v1.1.0
   ```

2. **Update Version**
   - Update `VERSION` file to `1.1.0`
   - Update all version references

3. **Final Testing**
   - Run full test suite
   - Manual testing on all providers
   - Performance benchmarks

4. **Merge to Main**
   ```bash
   git checkout main
   git merge release/v1.1.0
   ```

5. **Create Tag**
   ```bash
   git tag -a v1.1.0 -m "Release v1.1.0"
   git push origin v1.1.0
   ```

6. **Verify Automated Workflows**
   - GitHub Release created
   - Docker images pushed
   - PyPI package published

7. **Announce Release**
   - GitHub Discussions
   - Update documentation site
   - Social media (if applicable)

---

## 🎯 Success Metrics

### Feature Adoption
- PyPI download count
- Docker image pulls
- GitHub Stars/Forks
- Issue/Discussion activity

### Code Quality
- Test coverage ≥ 95%
- No critical bugs in first week
- Documentation completeness
- Performance benchmarks

### Community
- Contributor count
- Feature requests addressed
- Response time to issues
- Documentation quality feedback

---

## 📞 Next Steps

1. **Review this plan** - Team/Community feedback
2. **Break down into Issues** - Create GitHub issues for each feature
3. **Assign milestones** - Set target dates
4. **Start Implementation** - Begin with highest priority features
5. **Weekly Status Updates** - Track progress

---

**Document Status:** Draft v1
**Last Updated:** 2025-10-17
**Author:** GAL Development Team
