# GAL v1.2.0 - Implementierungsplan

**Target Release:** Q1 2026
**Focus:** Neue Gateway-Provider & Erweiterte Features
**Estimated Effort:** 8-10 Wochen

---

## ğŸ“‹ Feature Overview

| # | Feature | Priority | Status | Effort | Dependencies |
|---|---------|----------|--------|--------|--------------|
| 1 | Nginx Provider (Open Source) | ğŸ”´ High | âœ… Done | 3 Wochen | - |
| 2 | HAProxy Provider | ğŸ”´ High | âœ… Done | 2.5 Wochen | - |
| 3 | WebSocket Support | ğŸŸ¡ Medium | ğŸ”„ Pending | 2 Wochen | Nginx, HAProxy |
| 4 | Request/Response Body Transformation | ğŸŸ¡ Medium | ğŸ”„ Pending | 1.5 Wochen | - |
| 5 | Timeout & Retry Policies | ğŸŸ¡ Medium | ğŸ”„ Pending | 1 Woche | - |
| 6 | Enhanced Logging & Observability | ğŸŸ¢ Low | ğŸ”„ Pending | 1.5 Wochen | Optional |

**Total Estimated Effort:** 11.5 Wochen (mit optionalen Features)
**Progress:** 2/6 Features completed (33.3%)

---

## ğŸš€ Feature 1: Nginx Provider (Open Source)

**Status:** âœ… **IMPLEMENTED** (Commits: 3fbd1e0, 5982ee5)
**Priority:** ğŸ”´ High
**Effort:** 3 Wochen

### âœ… Implementation Summary

**Provider:** `gal/providers/nginx.py` (223 lines, 99% coverage)
- Complete nginx.conf generation
- Support for all load balancing algorithms (round_robin, least_conn, ip_hash, weighted)
- Rate limiting (limit_req_zone, limit_req)
- Basic authentication (auth_basic, htpasswd)
- Header manipulation (request/response)
- CORS policies (add_header directives)
- Passive health checks (max_fails, fail_timeout)
- Template variable conversion ({{uuid}} â†’ $request_id, {{now}} â†’ $time_iso8601)

**Tests:** `tests/test_nginx.py` (25 tests, all passing)
- Provider basics, validation warnings
- Load balancing (all 4 algorithms)
- Passive health checks
- Rate limiting (IP-based, header-based)
- Authentication (basic, API key, JWT)
- Header manipulation
- CORS policies
- Multiple services/routes
- All features combined

**Documentation:** `docs/guides/NGINX.md` (1000+ lines, German)
- Ãœbersicht & Feature-Matrix
- Installation & Setup
- Feature-by-Feature Anleitungen
- Provider-Vergleich
- Nginx-spezifische Details
- OpenResty Integration (JWT, API Key)
- Best Practices & Troubleshooting

**Examples:** `examples/nginx-example.yaml` (15 production-ready scenarios)
- Basic Reverse Proxy
- Load Balancing (Round Robin, Least Conn, IP Hash, Weighted)
- Passive Health Checks
- Rate Limiting (IP-based, Header-based)
- Basic Authentication
- Request/Response Headers
- CORS Configuration
- Combined Features (Production API)
- Microservices Architecture
- Static Content + API Hybrid

**CLI Integration:** âœ… Complete
- Added NginxProvider to all commands
- Extension map: nginx â†’ .conf
- Verified config generation works

**Limitations:**
- âŒ No Active Health Checks (Nginx Plus only)
- âš ï¸ JWT Auth requires OpenResty/Lua
- âš ï¸ Circuit Breaker requires Lua

### Motivation

- **Nginx ist der #1 Web Server** weltweit (>30% Marktanteil)
- Weit verbreitet als Reverse Proxy und Load Balancer
- Leichtgewichtig und performant
- GroÃŸe Community und umfangreiche Dokumentation
- Gute Basis fÃ¼r spÃ¤ter: Nginx Plus Support (v1.3.0)

### Nginx Capabilities (Open Source)

**UnterstÃ¼tzte Features:**
- âœ… Reverse Proxy
- âœ… Load Balancing (Round Robin, Least Connections, IP Hash, Weighted)
- âœ… HTTP/HTTPS/HTTP2
- âœ… SSL/TLS Termination
- âœ… Rate Limiting (ngx_http_limit_req_module)
- âœ… Basic Authentication (ngx_http_auth_basic_module)
- âœ… Header Manipulation (add_header, proxy_set_header)
- âœ… CORS (via add_header directives)
- âœ… Health Checks (passive via proxy_next_upstream)
- âœ… Upstream Targets mit Gewichtung
- âš ï¸ JWT Auth (nur mit OpenResty/Lua)
- âš ï¸ Circuit Breaker (limitiert, via Lua)

**EinschrÃ¤nkungen:**
- âŒ Keine nativen Active Health Checks (nur Nginx Plus)
- âŒ Keine native JWT Validation (benÃ¶tigt Lua/OpenResty)
- âŒ Keine Dynamic Configuration (ohne Plus)
- âŒ Limitierte Observability (ohne Plus)

### Implementation Tasks

#### 1. Provider Klasse (`gal/providers/nginx.py`)

```python
class NginxProvider(Provider):
    """Nginx Open Source Gateway Provider.

    Generates nginx.conf configuration for Nginx reverse proxy.
    Supports: routing, load balancing, rate limiting, basic auth,
    headers, CORS, passive health checks.

    Limitations:
    - No active health checks (Nginx Plus only)
    - JWT auth requires OpenResty/Lua
    - Circuit breaker requires Lua
    """

    def generate(self, config: GatewayConfig) -> str:
        """Generate nginx.conf configuration."""
        pass

    def _generate_upstream(self, service: Service) -> str:
        """Generate upstream block with load balancing."""
        pass

    def _generate_server(self, service: Service) -> str:
        """Generate server block for service."""
        pass

    def _generate_location(self, route: Route, service: Service) -> str:
        """Generate location block for route."""
        pass

    def _generate_rate_limit(self, route: Route) -> str:
        """Generate limit_req_zone and limit_req directives."""
        pass

    def _generate_headers(self, headers: HeaderManipulation) -> str:
        """Generate proxy_set_header and add_header directives."""
        pass

    def _generate_cors(self, cors: CORSPolicy) -> str:
        """Generate CORS headers via add_header."""
        pass
```

#### 2. Nginx Configuration Schema

**Upstream Block (Load Balancing):**
```nginx
upstream backend_service {
    # Load Balancing Algorithm
    least_conn;  # oder: ip_hash, hash $request_uri consistent

    # Backend Servers mit Gewichtung
    server api-1.internal:8080 weight=2 max_fails=3 fail_timeout=30s;
    server api-2.internal:8080 weight=1 max_fails=3 fail_timeout=30s;

    # Passive Health Check
    # max_fails: Nach wie vielen Fehlern wird Server als down markiert
    # fail_timeout: Wie lange wird Server als down betrachtet
}
```

**Server Block:**
```nginx
server {
    listen 80;
    server_name api.example.com;

    # Rate Limiting Zone (global definition)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

    location /api/v1 {
        # Rate Limiting
        limit_req zone=api_limit burst=200 nodelay;
        limit_req_status 429;

        # Basic Auth
        auth_basic "Protected Area";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Request Headers
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # CORS
        add_header Access-Control-Allow-Origin "https://app.example.com" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        add_header Access-Control-Max-Age 86400 always;

        # OPTIONS Preflight
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Response Headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Proxy to Upstream
        proxy_pass http://backend_service;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

#### 3. Feature Mapping

| GAL Feature | Nginx Implementation | Support Level |
|-------------|---------------------|---------------|
| **Rate Limiting** | limit_req_zone, limit_req | âœ… Full |
| **Load Balancing** | upstream (round_robin, least_conn, ip_hash) | âœ… Full |
| **Basic Auth** | auth_basic | âœ… Full |
| **API Key Auth** | Custom Lua module | âš ï¸ Limited (requires OpenResty) |
| **JWT Auth** | lua-resty-jwt | âš ï¸ Limited (requires OpenResty) |
| **Headers (Request)** | proxy_set_header | âœ… Full |
| **Headers (Response)** | add_header | âœ… Full |
| **CORS** | add_header directives | âœ… Full |
| **Health Checks (Passive)** | max_fails, fail_timeout | âœ… Full |
| **Health Checks (Active)** | N/A | âŒ Nginx Plus only |
| **Circuit Breaker** | Custom Lua | âš ï¸ Limited (requires Lua) |
| **Sticky Sessions** | ip_hash or hash | âœ… Full |

#### 4. Testing Strategy

**Unit Tests (`tests/test_nginx.py`):**
- Config generation for all features
- Upstream/Server/Location block generation
- Rate limiting directives
- Headers manipulation
- CORS configuration
- Load balancing algorithms

**Integration Tests:**
- nginx -t (config validation)
- Real Nginx deployment tests
- Feature compatibility matrix

**Coverage Goal:** 90%+

#### 5. Documentation

**Guide: `docs/guides/NGINX.md`**
- Nginx Setup & Installation
- GAL Configuration â†’ Nginx Config Mapping
- Feature-by-Feature Examples
- OpenResty Integration (fÃ¼r JWT/Circuit Breaker)
- Best Practices
- Troubleshooting

**Example Config: `examples/nginx-example.yaml`**
- 10+ Szenarien fÃ¼r verschiedene Use Cases
- Mit und ohne OpenResty
- Production-ready Beispiele

### Provider Comparison Matrix (Updated)

| Feature | Envoy | Kong | APISIX | Traefik | **Nginx** |
|---------|-------|------|--------|---------|-----------|
| Rate Limiting | âœ… | âœ… | âœ… | âœ… | âœ… |
| Basic Auth | âš ï¸ Lua | âœ… | âœ… | âœ… | âœ… |
| API Key Auth | âš ï¸ Lua | âœ… | âœ… | âš ï¸ | âš ï¸ OpenResty |
| JWT Auth | âœ… | âœ… | âœ… | âš ï¸ | âš ï¸ OpenResty |
| Headers | âœ… | âœ… | âœ… | âœ… | âœ… |
| CORS | âœ… | âœ… | âœ… | âœ… | âœ… |
| Circuit Breaker | âœ… | âš ï¸ | âœ… | âœ… | âš ï¸ Lua |
| Active Health Checks | âœ… | âœ… | âœ… | âœ… | âŒ (Plus only) |
| Passive Health Checks | âœ… | âœ… | âœ… | âš ï¸ | âœ… |
| Load Balancing | âœ… | âœ… | âœ… | âœ… | âœ… |

---

## ğŸ”€ Feature 2: HAProxy Provider

**Status:** âœ… **IMPLEMENTED** (Commits: f758eb8, 2961850, d964b82)
**Priority:** ğŸ”´ High
**Effort:** 2.5 Wochen

### âœ… Implementation Summary

**Provider:** `gal/providers/haproxy.py` (187 lines, 86% coverage)
- Complete haproxy.cfg generation
- Support for load balancing algorithms (roundrobin, leastconn, source, weighted)
- Active health checks (httpchk, fall/rise thresholds, expected status codes)
- Passive health checks (max_failures)
- Rate limiting (stick-table based, IP and header tracking)
- Header manipulation (http-request/http-response directives)
- ACLs (path_beg, method, header matching)
- Sticky sessions (cookie-based and source-based)
- CORS (via Access-Control-* headers)
- Template variable conversion ({{uuid}} â†’ %[uuid()], {{now}} â†’ %[date()])

**Tests:** `tests/test_haproxy.py` (10 tests, all passing)
- Provider name, basic config generation
- Load balancing (roundrobin, leastconn, weighted)
- Active health checks
- Rate limiting (IP-based)
- Request headers
- CORS configuration
- Sticky sessions

**Documentation:** `docs/guides/HAPROXY.md` (1100+ lines, German)
- Ãœbersicht & Feature-Matrix
- Installation & Setup
- Feature-by-Feature Anleitungen
- HAProxy-spezifische Details (haproxy.cfg, ACLs, Stats Page, Logging)
- Provider-Vergleich (vs Envoy, Kong, APISIX, Traefik, Nginx)
- Best Practices & Troubleshooting

**Examples:** `examples/haproxy-example.yaml` (16 production scenarios)
- Basic Load Balancing (Round Robin, Least Conn, Source IP Hash, Weighted)
- Active & Passive Health Checks
- Rate Limiting (IP-based, Header-based)
- Request/Response Header Manipulation
- CORS Configuration
- Sticky Sessions (Cookie-based)
- Combined Features (Production API, HA Payment Service)
- Microservices Architecture

**CLI Integration:** âœ… Complete
- Added HAProxyProvider to all commands
- Extension map: haproxy â†’ .cfg
- Verified config generation works
- Fixed validate() return type (None â†’ bool)

**Limitations:**
- âš ï¸ JWT Auth requires Lua scripting
- âš ï¸ Circuit Breaker requires Lua (basic via fall/rise)

### Motivation

- **HAProxy ist der de-facto Standard** fÃ¼r High-Performance Load Balancing
- Extrem performant (100k+ RPS)
- Enterprise-grade Reliability
- Umfangreiche Load Balancing Algorithmen
- Ausgezeichnete Health Checks & Observability
- Weit verbreitet in Production

### HAProxy Capabilities

**UnterstÃ¼tzte Features:**
- âœ… Advanced Load Balancing (roundrobin, leastconn, source, weighted)
- âœ… Active & Passive Health Checks (httpchk, fall/rise)
- âœ… HTTP/HTTPS/TCP Load Balancing
- âœ… SSL/TLS Termination
- âœ… Rate Limiting (stick-table based)
- âœ… Basic Authentication (auth realm)
- âœ… Header Manipulation (http-request/http-response)
- âœ… ACLs (Access Control Lists)
- âœ… Sticky Sessions (cookie-based, source-based)
- âœ… Connection Pooling
- âœ… CORS (via Access-Control-* headers)
- âš ï¸ JWT Auth (via Lua oder externe Auth)
- âš ï¸ Circuit Breaker (basic via fall/rise)

---

## ğŸŒ Feature 3: WebSocket Support

**Status:** ğŸ”„ **PENDING**
**Priority:** ğŸŸ¡ Medium
**Effort:** 2 Wochen
**Dependencies:** Nginx, HAProxy

### Motivation

- Real-time Kommunikation fÃ¼r Chat, Dashboards, Live Updates
- WebSocket ist Standard fÃ¼r bidirektionale Kommunikation
- Viele moderne Apps benÃ¶tigen WebSocket Support

### Implementation

**Config Model:**
```yaml
routes:
  - path_prefix: /ws
    websocket:
      enabled: true
      idle_timeout: 300s
      ping_interval: 30s
```

**Provider Support:**
- âœ… Envoy: Native WebSocket Support
- âœ… Kong: WebSocket Plugin
- âœ… APISIX: Native WebSocket
- âœ… Traefik: Native WebSocket
- âœ… **Nginx:** proxy_http_version 1.1, Connection upgrade
- âœ… **HAProxy:** Native WebSocket Support

---

## ğŸ”„ Feature 4: Request/Response Body Transformation

**Status:** ğŸ”„ **PENDING**
**Priority:** ğŸŸ¡ Medium
**Effort:** 1.5 Wochen

### Motivation

- Modify request/response bodies on-the-fly
- Data enrichment, filtering, format conversion
- API versioning support

### Implementation

**Config Model:**
```yaml
transformation:
  request_body:
    add_fields:
      timestamp: "{{now}}"
    remove_fields:
      - internal_id
  response_body:
    filter_fields:
      - password
      - secret_key
```

---

## â±ï¸ Feature 5: Timeout & Retry Policies

**Status:** ğŸ”„ **PENDING**
**Priority:** ğŸŸ¡ Medium
**Effort:** 1 Woche

### Config Model

```yaml
timeouts:
  connect: 5s
  send: 30s
  read: 60s

retry:
  enabled: true
  attempts: 3
  backoff: exponential
  retry_on:
    - connect_timeout
    - http_5xx
```

---

## ğŸ“Š Feature 6: Enhanced Logging & Observability

**Status:** ğŸ”„ **PENDING**
**Priority:** ğŸŸ¢ Low
**Effort:** 1.5 Wochen

### Features

- Structured Access Logs (JSON)
- Custom Log Formats
- Log Sampling
- OpenTelemetry Integration (Basic)
- Metrics Export (Prometheus)

---

## ğŸ“š Documentation Plan

### New Guides
1. `docs/guides/NGINX.md` - Nginx Provider Guide
2. `docs/guides/HAPROXY.md` - HAProxy Provider Guide
3. `docs/guides/WEBSOCKETS.md` - WebSocket Support
4. `docs/guides/BODY_TRANSFORMATION.md` - Request/Response Body Transformation
5. `docs/guides/TIMEOUTS_RETRIES.md` - Timeout & Retry Policies

### Updated Guides
- `README.md` - Add Nginx & HAProxy to provider list
- `ROADMAP.md` - Update v1.2.0 status

---

## ğŸ§ª Testing Strategy

### Test Coverage Goals
- **Unit Tests:** 95%+ coverage
- **Integration Tests:** All 6 providers (Envoy, Kong, APISIX, Traefik, Nginx, HAProxy)
- **E2E Tests:** Real gateway deployments

### New Test Files
- `tests/test_nginx.py` - Nginx provider tests (100+ tests)
- `tests/test_haproxy.py` - HAProxy provider tests (100+ tests)
- `tests/test_websocket.py` - WebSocket feature tests
- `tests/test_body_transformation.py` - Body transformation tests
- `tests/test_timeouts_retries.py` - Timeout/Retry tests

---

## ğŸš€ Release Plan

### Milestone 1: Nginx Provider (Woche 1-3)
- âœ… Nginx Provider Klasse
- âœ… Feature Mapping (Rate Limit, Auth, Headers, CORS, LB)
- âœ… Tests (100+)
- âœ… Dokumentation

### Milestone 2: HAProxy Provider (Woche 4-6)
- âœ… HAProxy Provider Klasse
- âœ… Advanced Load Balancing
- âœ… Health Checks
- âœ… Tests (100+)
- âœ… Dokumentation

### Milestone 3: WebSocket Support (Woche 7-8)
- âœ… WebSocket Config Model
- âœ… Provider Implementations
- âœ… Tests
- âœ… Dokumentation

### Milestone 4: Additional Features (Woche 9-10)
- âœ… Body Transformation
- âœ… Timeout & Retry Policies
- âœ… Enhanced Logging (optional)

### Milestone 5: Release Vorbereitung (Woche 11)
- âœ… Final Testing
- âœ… Documentation Review
- âœ… CHANGELOG.md & RELEASE_NOTES.md
- âœ… Release v1.2.0

---

## ğŸ“ Success Metrics

- **6 Gateway Providers** (Envoy, Kong, APISIX, Traefik, Nginx, HAProxy)
- **600+ Tests** (erhÃ¶ht von 400+)
- **95%+ Code Coverage**
- **10.000+ Zeilen Dokumentation**
- **WebSocket Support** fÃ¼r moderne Apps
- **Body Transformation** fÃ¼r API Versioning

---

**Document Status:** Draft v1
**Last Updated:** 2025-10-18
**Author:** GAL Development Team
