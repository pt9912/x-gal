# GAL v1.2.0 - Implementierungsplan

**Target Release:** Q1 2026
**Focus:** Neue Gateway-Provider & Erweiterte Features
**Estimated Effort:** 8-10 Wochen

---

## 📋 Feature Overview

| # | Feature | Priority | Status | Effort | Dependencies |
|---|---------|----------|--------|--------|--------------|
| 1 | Nginx Provider (Open Source) | 🔴 High | 🔄 Pending | 3 Wochen | - |
| 2 | HAProxy Provider | 🔴 High | 🔄 Pending | 2.5 Wochen | - |
| 3 | WebSocket Support | 🟡 Medium | 🔄 Pending | 2 Wochen | Nginx, HAProxy |
| 4 | Request/Response Body Transformation | 🟡 Medium | 🔄 Pending | 1.5 Wochen | - |
| 5 | Timeout & Retry Policies | 🟡 Medium | 🔄 Pending | 1 Woche | - |
| 6 | Enhanced Logging & Observability | 🟢 Low | 🔄 Pending | 1.5 Wochen | Optional |

**Total Estimated Effort:** 11.5 Wochen (mit optionalen Features)
**Progress:** 0/6 Features completed (0%)

---

## 🚀 Feature 1: Nginx Provider (Open Source)

**Status:** 🔄 **PENDING**
**Priority:** 🔴 High
**Effort:** 3 Wochen

### Motivation

- **Nginx ist der #1 Web Server** weltweit (>30% Marktanteil)
- Weit verbreitet als Reverse Proxy und Load Balancer
- Leichtgewichtig und performant
- Große Community und umfangreiche Dokumentation
- Gute Basis für später: Nginx Plus Support (v1.3.0)

### Nginx Capabilities (Open Source)

**Unterstützte Features:**
- ✅ Reverse Proxy
- ✅ Load Balancing (Round Robin, Least Connections, IP Hash, Weighted)
- ✅ HTTP/HTTPS/HTTP2
- ✅ SSL/TLS Termination
- ✅ Rate Limiting (ngx_http_limit_req_module)
- ✅ Basic Authentication (ngx_http_auth_basic_module)
- ✅ Header Manipulation (add_header, proxy_set_header)
- ✅ CORS (via add_header directives)
- ✅ Health Checks (passive via proxy_next_upstream)
- ✅ Upstream Targets mit Gewichtung
- ⚠️ JWT Auth (nur mit OpenResty/Lua)
- ⚠️ Circuit Breaker (limitiert, via Lua)

**Einschränkungen:**
- ❌ Keine nativen Active Health Checks (nur Nginx Plus)
- ❌ Keine native JWT Validation (benötigt Lua/OpenResty)
- ❌ Keine Dynamic Configuration (ohne Plus)
- ❌ Limitierte Observability (ohne Plus)

### Implementation Tasks

#### 1. Provider Klasse (`gal/providers/nginx.py`)

```python
class NginxProvider(Provider):
    """Nginx Open Source Gateway Provider.

    Generates nginx.conf configuration for Nginx reverse proxy.
    Supports: routing, load balancing, rate limiting, basic auth,
    headers, CORS, passive health checks.

    Limitations:
    - No active health checks (Nginx Plus only)
    - JWT auth requires OpenResty/Lua
    - Circuit breaker requires Lua
    """

    def generate(self, config: GatewayConfig) -> str:
        """Generate nginx.conf configuration."""
        pass

    def _generate_upstream(self, service: Service) -> str:
        """Generate upstream block with load balancing."""
        pass

    def _generate_server(self, service: Service) -> str:
        """Generate server block for service."""
        pass

    def _generate_location(self, route: Route, service: Service) -> str:
        """Generate location block for route."""
        pass

    def _generate_rate_limit(self, route: Route) -> str:
        """Generate limit_req_zone and limit_req directives."""
        pass

    def _generate_headers(self, headers: HeaderManipulation) -> str:
        """Generate proxy_set_header and add_header directives."""
        pass

    def _generate_cors(self, cors: CORSPolicy) -> str:
        """Generate CORS headers via add_header."""
        pass
```

#### 2. Nginx Configuration Schema

**Upstream Block (Load Balancing):**
```nginx
upstream backend_service {
    # Load Balancing Algorithm
    least_conn;  # oder: ip_hash, hash $request_uri consistent

    # Backend Servers mit Gewichtung
    server api-1.internal:8080 weight=2 max_fails=3 fail_timeout=30s;
    server api-2.internal:8080 weight=1 max_fails=3 fail_timeout=30s;

    # Passive Health Check
    # max_fails: Nach wie vielen Fehlern wird Server als down markiert
    # fail_timeout: Wie lange wird Server als down betrachtet
}
```

**Server Block:**
```nginx
server {
    listen 80;
    server_name api.example.com;

    # Rate Limiting Zone (global definition)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

    location /api/v1 {
        # Rate Limiting
        limit_req zone=api_limit burst=200 nodelay;
        limit_req_status 429;

        # Basic Auth
        auth_basic "Protected Area";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Request Headers
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # CORS
        add_header Access-Control-Allow-Origin "https://app.example.com" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        add_header Access-Control-Max-Age 86400 always;

        # OPTIONS Preflight
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Response Headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Proxy to Upstream
        proxy_pass http://backend_service;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

#### 3. Feature Mapping

| GAL Feature | Nginx Implementation | Support Level |
|-------------|---------------------|---------------|
| **Rate Limiting** | limit_req_zone, limit_req | ✅ Full |
| **Load Balancing** | upstream (round_robin, least_conn, ip_hash) | ✅ Full |
| **Basic Auth** | auth_basic | ✅ Full |
| **API Key Auth** | Custom Lua module | ⚠️ Limited (requires OpenResty) |
| **JWT Auth** | lua-resty-jwt | ⚠️ Limited (requires OpenResty) |
| **Headers (Request)** | proxy_set_header | ✅ Full |
| **Headers (Response)** | add_header | ✅ Full |
| **CORS** | add_header directives | ✅ Full |
| **Health Checks (Passive)** | max_fails, fail_timeout | ✅ Full |
| **Health Checks (Active)** | N/A | ❌ Nginx Plus only |
| **Circuit Breaker** | Custom Lua | ⚠️ Limited (requires Lua) |
| **Sticky Sessions** | ip_hash or hash | ✅ Full |

#### 4. Testing Strategy

**Unit Tests (`tests/test_nginx.py`):**
- Config generation for all features
- Upstream/Server/Location block generation
- Rate limiting directives
- Headers manipulation
- CORS configuration
- Load balancing algorithms

**Integration Tests:**
- nginx -t (config validation)
- Real Nginx deployment tests
- Feature compatibility matrix

**Coverage Goal:** 90%+

#### 5. Documentation

**Guide: `docs/guides/NGINX.md`**
- Nginx Setup & Installation
- GAL Configuration → Nginx Config Mapping
- Feature-by-Feature Examples
- OpenResty Integration (für JWT/Circuit Breaker)
- Best Practices
- Troubleshooting

**Example Config: `examples/nginx-example.yaml`**
- 10+ Szenarien für verschiedene Use Cases
- Mit und ohne OpenResty
- Production-ready Beispiele

### Provider Comparison Matrix (Updated)

| Feature | Envoy | Kong | APISIX | Traefik | **Nginx** |
|---------|-------|------|--------|---------|-----------|
| Rate Limiting | ✅ | ✅ | ✅ | ✅ | ✅ |
| Basic Auth | ⚠️ Lua | ✅ | ✅ | ✅ | ✅ |
| API Key Auth | ⚠️ Lua | ✅ | ✅ | ⚠️ | ⚠️ OpenResty |
| JWT Auth | ✅ | ✅ | ✅ | ⚠️ | ⚠️ OpenResty |
| Headers | ✅ | ✅ | ✅ | ✅ | ✅ |
| CORS | ✅ | ✅ | ✅ | ✅ | ✅ |
| Circuit Breaker | ✅ | ⚠️ | ✅ | ✅ | ⚠️ Lua |
| Active Health Checks | ✅ | ✅ | ✅ | ✅ | ❌ (Plus only) |
| Passive Health Checks | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| Load Balancing | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 🔀 Feature 2: HAProxy Provider

**Status:** 🔄 **PENDING**
**Priority:** 🔴 High
**Effort:** 2.5 Wochen

### Motivation

- **HAProxy ist der de-facto Standard** für High-Performance Load Balancing
- Extrem performant (100k+ RPS)
- Enterprise-grade Reliability
- Umfangreiche Load Balancing Algorithmen
- Ausgezeichnete Health Checks & Observability
- Weit verbreitet in Production

### HAProxy Capabilities

**Unterstützte Features:**
- ✅ Advanced Load Balancing (10+ Algorithmen)
- ✅ Active & Passive Health Checks
- ✅ HTTP/HTTPS/TCP Load Balancing
- ✅ SSL/TLS Termination
- ✅ Rate Limiting (stick-tables)
- ✅ Basic Authentication
- ✅ Header Manipulation (req.hdr, res.hdr)
- ✅ ACLs (Access Control Lists)
- ✅ Circuit Breaker (via server checks)
- ✅ Sticky Sessions (multiple methods)
- ✅ Connection Pooling
- ⚠️ JWT Auth (via Lua oder externe Auth)
- ⚠️ CORS (via custom headers, nicht native)

### Implementation Tasks

#### 1. Provider Klasse (`gal/providers/haproxy.py`)

```python
class HAProxyProvider(Provider):
    """HAProxy Load Balancer Provider.

    Generates haproxy.cfg configuration.
    Supports: advanced load balancing, health checks, rate limiting,
    headers, ACLs, sticky sessions.
    """

    def generate(self, config: GatewayConfig) -> str:
        """Generate haproxy.cfg configuration."""
        pass

    def _generate_backend(self, service: Service) -> str:
        """Generate backend section with servers."""
        pass

    def _generate_frontend(self, service: Service) -> str:
        """Generate frontend section."""
        pass

    def _generate_health_checks(self, hc: HealthCheckConfig) -> str:
        """Generate health check configuration."""
        pass

    def _generate_rate_limit(self, route: Route) -> str:
        """Generate stick-table based rate limiting."""
        pass
```

#### 2. HAProxy Configuration Schema

**Backend (Servers + Health Checks):**
```haproxy
backend backend_service
    balance leastconn  # oder: roundrobin, source, uri, hdr(host)

    # Health Checks
    option httpchk GET /health HTTP/1.1
    http-check expect status 200

    # Server Definitions
    server api-1 api-1.internal:8080 check weight 2 inter 10s fall 3 rise 2
    server api-2 api-2.internal:8080 check weight 1 inter 10s fall 3 rise 2

    # Sticky Sessions
    cookie SERVERID insert indirect nocache
```

**Frontend (Routing + ACLs):**
```haproxy
frontend api_frontend
    bind *:80

    # Rate Limiting (stick-table)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # ACLs für Routing
    acl is_api_v1 path_beg /api/v1

    # Request Headers
    http-request set-header X-Request-ID %[uuid()]
    http-request set-header X-Real-IP %[src]

    # Response Headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff

    # Backend Selection
    use_backend backend_service if is_api_v1
```

---

## 🌐 Feature 3: WebSocket Support

**Status:** 🔄 **PENDING**
**Priority:** 🟡 Medium
**Effort:** 2 Wochen
**Dependencies:** Nginx, HAProxy

### Motivation

- Real-time Kommunikation für Chat, Dashboards, Live Updates
- WebSocket ist Standard für bidirektionale Kommunikation
- Viele moderne Apps benötigen WebSocket Support

### Implementation

**Config Model:**
```yaml
routes:
  - path_prefix: /ws
    websocket:
      enabled: true
      idle_timeout: 300s
      ping_interval: 30s
```

**Provider Support:**
- ✅ Envoy: Native WebSocket Support
- ✅ Kong: WebSocket Plugin
- ✅ APISIX: Native WebSocket
- ✅ Traefik: Native WebSocket
- ✅ **Nginx:** proxy_http_version 1.1, Connection upgrade
- ✅ **HAProxy:** Native WebSocket Support

---

## 🔄 Feature 4: Request/Response Body Transformation

**Status:** 🔄 **PENDING**
**Priority:** 🟡 Medium
**Effort:** 1.5 Wochen

### Motivation

- Modify request/response bodies on-the-fly
- Data enrichment, filtering, format conversion
- API versioning support

### Implementation

**Config Model:**
```yaml
transformation:
  request_body:
    add_fields:
      timestamp: "{{now}}"
    remove_fields:
      - internal_id
  response_body:
    filter_fields:
      - password
      - secret_key
```

---

## ⏱️ Feature 5: Timeout & Retry Policies

**Status:** 🔄 **PENDING**
**Priority:** 🟡 Medium
**Effort:** 1 Woche

### Config Model

```yaml
timeouts:
  connect: 5s
  send: 30s
  read: 60s

retry:
  enabled: true
  attempts: 3
  backoff: exponential
  retry_on:
    - connect_timeout
    - http_5xx
```

---

## 📊 Feature 6: Enhanced Logging & Observability

**Status:** 🔄 **PENDING**
**Priority:** 🟢 Low
**Effort:** 1.5 Wochen

### Features

- Structured Access Logs (JSON)
- Custom Log Formats
- Log Sampling
- OpenTelemetry Integration (Basic)
- Metrics Export (Prometheus)

---

## 📚 Documentation Plan

### New Guides
1. `docs/guides/NGINX.md` - Nginx Provider Guide
2. `docs/guides/HAPROXY.md` - HAProxy Provider Guide
3. `docs/guides/WEBSOCKETS.md` - WebSocket Support
4. `docs/guides/BODY_TRANSFORMATION.md` - Request/Response Body Transformation
5. `docs/guides/TIMEOUTS_RETRIES.md` - Timeout & Retry Policies

### Updated Guides
- `README.md` - Add Nginx & HAProxy to provider list
- `ROADMAP.md` - Update v1.2.0 status

---

## 🧪 Testing Strategy

### Test Coverage Goals
- **Unit Tests:** 95%+ coverage
- **Integration Tests:** All 6 providers (Envoy, Kong, APISIX, Traefik, Nginx, HAProxy)
- **E2E Tests:** Real gateway deployments

### New Test Files
- `tests/test_nginx.py` - Nginx provider tests (100+ tests)
- `tests/test_haproxy.py` - HAProxy provider tests (100+ tests)
- `tests/test_websocket.py` - WebSocket feature tests
- `tests/test_body_transformation.py` - Body transformation tests
- `tests/test_timeouts_retries.py` - Timeout/Retry tests

---

## 🚀 Release Plan

### Milestone 1: Nginx Provider (Woche 1-3)
- ✅ Nginx Provider Klasse
- ✅ Feature Mapping (Rate Limit, Auth, Headers, CORS, LB)
- ✅ Tests (100+)
- ✅ Dokumentation

### Milestone 2: HAProxy Provider (Woche 4-6)
- ✅ HAProxy Provider Klasse
- ✅ Advanced Load Balancing
- ✅ Health Checks
- ✅ Tests (100+)
- ✅ Dokumentation

### Milestone 3: WebSocket Support (Woche 7-8)
- ✅ WebSocket Config Model
- ✅ Provider Implementations
- ✅ Tests
- ✅ Dokumentation

### Milestone 4: Additional Features (Woche 9-10)
- ✅ Body Transformation
- ✅ Timeout & Retry Policies
- ✅ Enhanced Logging (optional)

### Milestone 5: Release Vorbereitung (Woche 11)
- ✅ Final Testing
- ✅ Documentation Review
- ✅ CHANGELOG.md & RELEASE_NOTES.md
- ✅ Release v1.2.0

---

## 📝 Success Metrics

- **6 Gateway Providers** (Envoy, Kong, APISIX, Traefik, Nginx, HAProxy)
- **600+ Tests** (erhöht von 400+)
- **95%+ Code Coverage**
- **10.000+ Zeilen Dokumentation**
- **WebSocket Support** für moderne Apps
- **Body Transformation** für API Versioning

---

**Document Status:** Draft v1
**Last Updated:** 2025-10-18
**Author:** GAL Development Team
