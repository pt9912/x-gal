services:
  # Backend - Primary (production traffic)
  backend-primary:
    build:
      context: ../backends
      dockerfile: Dockerfile
    command: ["python", "-u", "/app/primary.py"]
    environment:
      - PORT=8080
    networks:
      - test-network-apisix-mirroring
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080')"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Backend - Shadow (mirrored traffic)
  backend-shadow:
    build:
      context: ../backends
      dockerfile: Dockerfile
    command: ["python", "-u", "/app/shadow.py"]
    environment:
      - PORT=8080
    networks:
      - test-network-apisix-mirroring
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080')"]
      interval: 5s
      timeout: 3s
      retries: 3

  # etcd for APISIX configuration storage
  etcd:
    image: quay.io/coreos/etcd:v3.5.15
    command:
      - /usr/local/bin/etcd
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd:2379
    networks:
      - test-network-apisix-mirroring
    healthcheck:
      test: ["CMD", "/usr/local/bin/etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # APISIX Gateway with Request Mirroring
  apisix:
    image: apache/apisix:3.7.0-debian
    volumes:
      - ./apisix-config.yaml:/usr/local/apisix/conf/config.yaml:ro
    ports:
      - "10003:9080"  # Proxy port (different from Envoy/Nginx tests)
      - "9182:9180"   # Admin API port (different from other tests)
    networks:
      - test-network-apisix-mirroring
    environment:
      - APISIX_STAND_ALONE=false
    depends_on:
      etcd:
        condition: service_healthy
      backend-primary:
        condition: service_healthy
      backend-shadow:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9180/apisix/admin/routes", "-H", "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1"]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 15s

networks:
  test-network-apisix-mirroring:
    driver: bridge
