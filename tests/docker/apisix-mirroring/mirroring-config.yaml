version: "1.0"
provider: apisix

global_config:
  host: "0.0.0.0"
  port: 9080
  timeout: "60s"

services:
  - name: api-service
    type: rest
    protocol: http
    upstream:
      host: backend-primary
      port: 8080

    routes:
      # Route 1: 100% Request Mirroring to Shadow Backend
      - path_prefix: /api/v1
        methods: ["GET", "POST", "PUT", "DELETE"]
        mirroring:
          enabled: true
          mirror_request_body: true
          targets:
            - name: shadow-v1
              upstream:
                host: backend-shadow
                port: 8080
              sample_percentage: 100.0  # Mirror 100% of requests
              headers:
                X-Mirror: "true"
                X-Shadow-Version: "v1"

      # Route 2: 50% Request Mirroring (Sampling)
      - path_prefix: /api/v2
        methods: ["GET", "POST", "PUT", "DELETE"]
        mirroring:
          enabled: true
          mirror_request_body: true
          targets:
            - name: shadow-v2
              upstream:
                host: backend-shadow
                port: 8080
              sample_percentage: 50.0  # Mirror 50% of requests
              headers:
                X-Mirror: "true"
                X-Shadow-Version: "v2"

      # Route 3: No Mirroring (Baseline)
      - path_prefix: /api/v3
        methods: ["GET", "POST", "PUT", "DELETE"]
        # No mirroring configured - baseline for comparison

  # Health check endpoint
  - name: health-service
    type: rest
    protocol: http
    upstream:
      host: backend-primary
      port: 8080

    routes:
      - path_prefix: /health
        methods: ["GET"]
