# SPOE Configuration for Request Mirroring
# Stream Processing Offload Engine - HAProxy 2.0+
# This file configures the SPOE agent for async request mirroring

[mirror]

# SPOE Agent Definition - Connects to spoa-mirror process
spoe-agent mirror-agent
    # Message types to process
    messages   mirror-request

    # Async processing (fire-and-forget)
    option     async

    # Variable prefix for SPOE-generated variables
    option     var-prefix mirror

    # Timeouts
    timeout    hello      2s
    timeout    idle       30s
    timeout    processing 500ms

    # Rate limiting for SPOE agent (prevent overload)
    maxconnrate 100   # Max new connections per second
    maxerrrate  50    # Max errors per second before throttling

    # Backend connection to SPOE agent
    use-backend spoe-mirror

    # Logging
    log global

# SPOE Message Definition - What data to send to mirror agent
spoe-message mirror-request
    # Arguments to send to spoa-mirror agent
    # Use standard HAProxy sample fetch methods
    args method=req.meth uri=path

    # Event trigger - when to send the message
    # Use on-backend-http-request (AFTER http-request rules execute)
    # so that txn.mirror_enabled is already set
    event on-backend-http-request if { var(txn.mirror_enabled) -m bool }
