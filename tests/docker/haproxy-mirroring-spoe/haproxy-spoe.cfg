# HAProxy Configuration with SPOE Request Mirroring
# Production-ready example using Stream Processing Offload Engine
# HAProxy 2.0+

global
    log stdout format raw local0 info
    maxconn 4096
    stats timeout 2m

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    timeout http-request 10s
    timeout queue 1m

# SPOE Backend - Connection to spoa-mirror agent
backend spoe-mirror
    mode tcp
    # Connect to spoa-mirror agent on port 12345
    server spoe1 spoa-mirror:12345 check

# Frontend - Main entry point with SPOE filter
frontend http_front
    bind *:10000
    mode http

    # Load SPOE filter for request mirroring
    filter spoe engine mirror config /usr/local/etc/haproxy/spoe-mirror.conf

    # ACL definitions for routing
    acl is_api_v1 path_beg /api/v1
    acl is_api_v2 path_beg /api/v2
    acl is_api_v3 path_beg /api/v3
    acl is_health path /health

    # Health check endpoint (no mirroring)
    use_backend health_backend if is_health

    # Route 1: /api/v1 - 100% mirroring to shadow backend
    # Set mirroring flag for SPOE
    http-request set-var(txn.mirror_enabled) bool(true) if is_api_v1
    use_backend api_v1_backend if is_api_v1

    # Route 2: /api/v2 - 50% mirroring (sampling)
    # Use rand() to sample 50% of traffic
    acl mirror_sample_50 rand(50)
    http-request set-var(txn.mirror_enabled) bool(true) if is_api_v2 mirror_sample_50
    use_backend api_v2_backend if is_api_v2

    # Route 3: /api/v3 - No mirroring (baseline)
    use_backend api_v3_backend if is_api_v3

    # Default backend
    default_backend api_v1_backend

# Backend for /api/v1 - 100% mirroring via SPOE
backend api_v1_backend
    mode http
    balance roundrobin

    # IMPORTANT: Buffer request body for POST/PUT mirroring
    option http-buffer-request

    # Primary backend server (production traffic)
    server primary backend-primary:8080 check

    # Add custom headers
    http-request set-header X-Mirror-Enabled "true"
    http-request set-header X-Backend-Type "primary"

# Backend for /api/v2 - 50% mirroring via SPOE
backend api_v2_backend
    mode http
    balance roundrobin

    # Buffer request body for mirroring
    option http-buffer-request

    # Primary backend server
    server primary backend-primary:8080 check

    # Add custom headers
    http-request set-header X-Mirror-Enabled "50%%"
    http-request set-header X-Backend-Type "primary"

# Backend for /api/v3 - No mirroring (baseline)
backend api_v3_backend
    mode http
    balance roundrobin

    # Primary backend server only
    server primary backend-primary:8080 check

    # Add custom headers
    http-request set-header X-Mirror-Enabled "false"
    http-request set-header X-Backend-Type "primary"

# Health check backend
backend health_backend
    mode http
    http-request return status 200 content-type "text/plain" string "healthy\n"

# Stats endpoint for monitoring
listen stats
    bind *:9999
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
