#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log         127.0.0.1 local0
    maxconn     4000

#---------------------------------------------------------------------
# Common defaults
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option                  http-server-close
    option                  forwardfor except 127.0.0.0/8
    timeout connect         5s
    timeout client          30s
    timeout server          30s

#---------------------------------------------------------------------
# Frontend - Main HTTP Router
#---------------------------------------------------------------------
frontend http_frontend
    bind 0.0.0.0:8080

    # ACL for canary_deployment_api - /api/v1
    acl is_canary_deployment_api path_beg /api/v1
    use_backend backend_canary_deployment_api if is_canary_deployment_api

#---------------------------------------------------------------------
# Backend - canary_deployment_api (90% stable, 10% canary)
#---------------------------------------------------------------------
backend backend_canary_deployment_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers with weights for 90/10 split
    server server_stable backend-stable:8080 check inter 10s fall 3 rise 2 weight 90
    server server_canary backend-canary:8080 check inter 10s fall 3 rise 2 weight 10
