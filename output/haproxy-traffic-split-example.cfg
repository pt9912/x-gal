#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log         127.0.0.1 local0
    log         127.0.0.1 local1 notice
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

    # Stats socket for runtime API
    stats socket /var/lib/haproxy/stats level admin
    stats timeout 30s

#---------------------------------------------------------------------
# Common defaults
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option                  http-server-close
    option                  forwardfor except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    30s
    timeout queue           30s
    timeout connect         5s
    timeout client          30s
    timeout server          30s
    timeout http-keep-alive 10s
    timeout check           5s
    maxconn                 3000

#---------------------------------------------------------------------
# Frontend - Main HTTP Router
#---------------------------------------------------------------------
frontend http_frontend
    bind 0.0.0.0:8080

    # ACL for canary_deployment_api - /api/v1
    acl is_canary_deployment_api_route0 path_beg /api/v1
    acl is_canary_deployment_api_route0_method method GET POST PUT DELETE

    # ACL for ab_testing_api - /api/v2
    acl is_ab_testing_api_route0 path_beg /api/v2
    acl is_ab_testing_api_route0_method method GET POST

    # ACL for beta_testing_api - /api/beta
    acl is_beta_testing_api_route0 path_beg /api/beta
    acl is_beta_testing_api_route0_method method GET POST PUT DELETE

    # ACL for user_segment_api - /api/users
    acl is_user_segment_api_route0 path_beg /api/users
    acl is_user_segment_api_route0_method method GET POST PUT DELETE

    # ACL for multi_rule_api - /api/multi
    acl is_multi_rule_api_route0 path_beg /api/multi
    acl is_multi_rule_api_route0_method method GET POST

    # ACL for gradual_rollout_api - /api/rollout
    acl is_gradual_rollout_api_route0 path_beg /api/rollout
    acl is_gradual_rollout_api_route0_method method GET POST

    # Backend routing
    use_backend backend_canary_deployment_api if is_canary_deployment_api_route0 is_canary_deployment_api_route0_method
    use_backend backend_ab_testing_api if is_ab_testing_api_route0 is_ab_testing_api_route0_method
    use_backend backend_beta_testing_api if is_beta_testing_api_route0 is_beta_testing_api_route0_method
    use_backend backend_user_segment_api if is_user_segment_api_route0 is_user_segment_api_route0_method
    use_backend backend_multi_rule_api if is_multi_rule_api_route0 is_multi_rule_api_route0_method
    use_backend backend_gradual_rollout_api if is_gradual_rollout_api_route0 is_gradual_rollout_api_route0_method

#---------------------------------------------------------------------
# Backend - canary_deployment_api
#---------------------------------------------------------------------
backend backend_canary_deployment_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers
    server server_stable api-v1-stable:8080 check inter 10s fall 3 rise 2 weight 230
    server server_canary api-v1-canary:8080 check inter 10s fall 3 rise 2 weight 25

#---------------------------------------------------------------------
# Backend - ab_testing_api
#---------------------------------------------------------------------
backend backend_ab_testing_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers
    server server_version_a api-v2-a:8080 check inter 10s fall 3 rise 2 weight 128
    server server_version_b api-v2-b:8080 check inter 10s fall 3 rise 2 weight 128

#---------------------------------------------------------------------
# Backend - beta_testing_api
#---------------------------------------------------------------------
backend backend_beta_testing_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers
    server server_production api-prod:8080 check inter 10s fall 3 rise 2 weight 256
    server server_beta api-beta:8080 check inter 10s fall 3 rise 2

#---------------------------------------------------------------------
# Backend - user_segment_api
#---------------------------------------------------------------------
backend backend_user_segment_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers
    server server_stable api-stable:8080 check inter 10s fall 3 rise 2 weight 256
    server server_canary_users api-canary:8080 check inter 10s fall 3 rise 2

#---------------------------------------------------------------------
# Backend - multi_rule_api
#---------------------------------------------------------------------
backend backend_multi_rule_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers
    server server_stable api-stable:8080 check inter 10s fall 3 rise 2 weight 179
    server server_beta api-beta:8080 check inter 10s fall 3 rise 2 weight 51
    server server_canary api-canary:8080 check inter 10s fall 3 rise 2 weight 25

#---------------------------------------------------------------------
# Backend - gradual_rollout_api
#---------------------------------------------------------------------
backend backend_gradual_rollout_api
    balance roundrobin
    option httpclose
    option forwardfor

    # Backend servers
    server server_current_version api-v1:8080 check inter 10s fall 3 rise 2 weight 243
    server server_new_version api-v2:8080 check inter 10s fall 3 rise 2 weight 12
