{
  "routes": [
    {
      "uri": "/api/v1/*",
      "name": "canary_deployment_api_route",
      "service_id": "canary_deployment_api",
      "methods": [
        "GET",
        "POST",
        "PUT",
        "DELETE"
      ],
      "plugins": {
        "traffic-split": {
          "rules": [
            {
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "canary_deployment_api_stable_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-v1-stable:8080": 1
                    }
                  },
                  "weight": 90
                },
                {
                  "upstream": {
                    "name": "canary_deployment_api_canary_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-v1-canary:8080": 1
                    }
                  },
                  "weight": 10
                }
              ]
            }
          ]
        }
      }
    },
    {
      "uri": "/api/v2/*",
      "name": "ab_testing_api_route",
      "service_id": "ab_testing_api",
      "methods": [
        "GET",
        "POST"
      ],
      "plugins": {
        "traffic-split": {
          "rules": [
            {
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "ab_testing_api_version_a_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-v2-a:8080": 1
                    }
                  },
                  "weight": 50
                },
                {
                  "upstream": {
                    "name": "ab_testing_api_version_b_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-v2-b:8080": 1
                    }
                  },
                  "weight": 50
                }
              ]
            }
          ]
        }
      }
    },
    {
      "uri": "/api/beta/*",
      "name": "beta_testing_api_route",
      "service_id": "beta_testing_api",
      "methods": [
        "GET",
        "POST",
        "PUT",
        "DELETE"
      ],
      "plugins": {
        "traffic-split": {
          "rules": [
            {
              "match": [
                {
                  "vars": [
                    [
                      "http_x_version",
                      "==",
                      "beta"
                    ]
                  ]
                }
              ],
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "beta_testing_api_beta_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-beta:8080": 1
                    }
                  },
                  "weight": 1
                }
              ]
            },
            {
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "beta_testing_api_production_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-prod:8080": 1
                    }
                  },
                  "weight": 100
                }
              ]
            }
          ]
        }
      }
    },
    {
      "uri": "/api/users/*",
      "name": "user_segment_api_route",
      "service_id": "user_segment_api",
      "methods": [
        "GET",
        "POST",
        "PUT",
        "DELETE"
      ],
      "plugins": {
        "traffic-split": {
          "rules": [
            {
              "match": [
                {
                  "vars": [
                    [
                      "cookie_canary_user",
                      "==",
                      "true"
                    ]
                  ]
                }
              ],
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "user_segment_api_canary_users_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-canary:8080": 1
                    }
                  },
                  "weight": 1
                }
              ]
            },
            {
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "user_segment_api_stable_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-stable:8080": 1
                    }
                  },
                  "weight": 100
                }
              ]
            }
          ]
        }
      }
    },
    {
      "uri": "/api/multi/*",
      "name": "multi_rule_api_route",
      "service_id": "multi_rule_api",
      "methods": [
        "GET",
        "POST"
      ],
      "plugins": {
        "traffic-split": {
          "rules": [
            {
              "match": [
                {
                  "vars": [
                    [
                      "http_x_version",
                      "==",
                      "beta"
                    ]
                  ]
                }
              ],
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "multi_rule_api_beta_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-beta:8080": 1
                    }
                  },
                  "weight": 1
                }
              ]
            },
            {
              "match": [
                {
                  "vars": [
                    [
                      "http_x_version",
                      "==",
                      "canary"
                    ]
                  ]
                }
              ],
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "multi_rule_api_canary_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-canary:8080": 1
                    }
                  },
                  "weight": 1
                }
              ]
            },
            {
              "match": [
                {
                  "vars": [
                    [
                      "cookie_user_tier",
                      "==",
                      "premium"
                    ]
                  ]
                }
              ],
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "multi_rule_api_beta_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-beta:8080": 1
                    }
                  },
                  "weight": 1
                }
              ]
            },
            {
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "multi_rule_api_stable_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-stable:8080": 1
                    }
                  },
                  "weight": 70
                },
                {
                  "upstream": {
                    "name": "multi_rule_api_beta_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-beta:8080": 1
                    }
                  },
                  "weight": 20
                },
                {
                  "upstream": {
                    "name": "multi_rule_api_canary_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-canary:8080": 1
                    }
                  },
                  "weight": 10
                }
              ]
            }
          ]
        }
      }
    },
    {
      "uri": "/api/rollout/*",
      "name": "gradual_rollout_api_route",
      "service_id": "gradual_rollout_api",
      "methods": [
        "GET",
        "POST"
      ],
      "plugins": {
        "traffic-split": {
          "rules": [
            {
              "weighted_upstreams": [
                {
                  "upstream": {
                    "name": "gradual_rollout_api_current_version_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-v1:8080": 1
                    }
                  },
                  "weight": 95
                },
                {
                  "upstream": {
                    "name": "gradual_rollout_api_new_version_upstream",
                    "type": "roundrobin",
                    "nodes": {
                      "api-v2:8080": 1
                    }
                  },
                  "weight": 5
                }
              ]
            }
          ]
        }
      }
    }
  ],
  "upstreams": [
    {
      "id": "canary_deployment_api_upstream",
      "type": "roundrobin",
      "nodes": {
        "placeholder:8080": 1
      }
    },
    {
      "id": "ab_testing_api_upstream",
      "type": "roundrobin",
      "nodes": {
        "placeholder:8080": 1
      }
    },
    {
      "id": "beta_testing_api_upstream",
      "type": "roundrobin",
      "nodes": {
        "placeholder:8080": 1
      }
    },
    {
      "id": "user_segment_api_upstream",
      "type": "roundrobin",
      "nodes": {
        "placeholder:8080": 1
      }
    },
    {
      "id": "multi_rule_api_upstream",
      "type": "roundrobin",
      "nodes": {
        "placeholder:8080": 1
      }
    },
    {
      "id": "gradual_rollout_api_upstream",
      "type": "roundrobin",
      "nodes": {
        "placeholder:8080": 1
      }
    }
  ],
  "services": [
    {
      "id": "canary_deployment_api",
      "upstream_id": "canary_deployment_api_upstream"
    },
    {
      "id": "ab_testing_api",
      "upstream_id": "ab_testing_api_upstream"
    },
    {
      "id": "beta_testing_api",
      "upstream_id": "beta_testing_api_upstream"
    },
    {
      "id": "user_segment_api",
      "upstream_id": "user_segment_api_upstream"
    },
    {
      "id": "multi_rule_api",
      "upstream_id": "multi_rule_api_upstream"
    },
    {
      "id": "gradual_rollout_api",
      "upstream_id": "gradual_rollout_api_upstream"
    }
  ]
}